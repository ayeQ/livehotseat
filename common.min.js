const YouHostLive=function(){async function e(){if(pe)return;pe=!0,o(),a(),await Promise.all([d("https://apis.google.com/js/platform.js",!1),d("https://www.youtube.com/iframe_api",!1),d("https://challenges.cloudflare.com/turnstile/v0/api.js",!1),d("https://unpkg.com/@supabase/supabase-js@2.43.3/dist/umd/supabase.js",!1),d("https://unpkg.com/gsap@3/dist/gsap.min.js",!1),d("https://unpkg.com/gsap@3/dist/TextPlugin.min.js",!1),d("https://unpkg.com/gsap@3/dist/SplitText.min.js",!1),d("https://unpkg.com/@vonage/client-sdk-video@2/dist/js/opentok.js",!1),d("https://unpkg.com/opentok-layout-js@5.5.0/opentok-layout.js",!1),d(`https://youhostlive.nightowllogic.com/${te?G:G+".min"}.js`,!0),u("https://youhostlive.nightowllogic.com/common.css"),u(`https://youhostlive.nightowllogic.com/${G}.css`)]),re=window.supabase.createClient(ne,oe);const e=document.createElement("div");e.id="turnstile-container",document.body.appendChild(e);const t=document.createElement("div");if(t.id="version",t.style.display="none",t.innerHTML=W,document.body.appendChild(t),await p(),re.auth.onAuthStateChange(async(e,t)=>{switch(e){case"INITIAL_SESSION":const{error:n,success:o}=await y();if(n)throw n;o?(Le=t,await h(!0)):Le=null,X&&(o?await C():document.getElementById("sign-in-flexbox").style.display="flex"),ee&&(o||(await h(),fe=null));break;case"SIGNED_IN":Le=t,X&&null==be&&(await h(!0),await C())}}),ee){const e=document.createElement("div");e.className="g-ytsubscribe",e.dataset.channel="weekdazelive",e.dataset.layout="default",e.dataset.count="default",e.dataset.theme="dark",document.body.appendChild(e),window.gapi&&gapi.ytsubscribe&&gapi.ytsubscribe.go&&gapi.ytsubscribe.go(document.body),document.getElementById("text-name").setAttribute("maxlength","25"),document.getElementById("textarea-comment").setAttribute("maxlength","130"),we=document.createElement("video"),we.id="user-camera-live-audience-video",we.style.width="160px",we.style.height="160px",we.style.borderRadius="6px",we.style.background="#000",we.style.display="block",we.style.objectFit="cover",we.autoplay=!0,we.playsInline=!0,we.addEventListener("loadeddata",async function(){i({event:"SIGNED_IN_WITH_EMAIL"}),await x()});const t=document.getElementById("live-audience-body"),n=document.getElementById("sign-out-camera-button");t.insertBefore(we,n)}X&&(ae.addEventListener("mouseup",async()=>{await v()}),se.style.display="checked"==se.dataset.state?"flex":"none",ie.addEventListener("mouseup",async e=>{switch(e.target.dataset.state){case"unchecked":se.style.display="none";break;case"checked":se.style.display="flex"}})),window.addEventListener("blur",()=>_isBlurred=!0),window.addEventListener("focus",()=>_isBlurred=!1);const n=document.createElement("div");n.id="layoutContainer",document.body.appendChild(n),clearInterval(Me),document.getElementById("loading-dialog").style.display="none",document.getElementById("loading-text").innerHTML="Loading...",i({event:"READY"})}function t(){const e=document.currentScript,t=new URL(e.src),n=new URLSearchParams(t.search),o=n.get("app");return o}function n(){const e=localStorage.getItem("is-host-on-client");return e}function o(){const e=localStorage.getItem("YouHostLiveUserIds");null!=e&&(He=JSON.parse(e))}function a(){if(!ee&&!X)throw new Error("You Host Live App Website Permission Error.");const e=te?`https://${G}com.wstd.io`:`https://www.${G}.com`,t=te?`https://${G}live.wstd.io`:`https://www.${G}.live`;if(window.location.origin!=e&&window.location.origin!=t)throw new Error("You Host Live App Website Permission Error.")}function i(e){"function"==typeof xe&&xe(e)}function s(e){xe=e}function c(){Te=document.createElement("iframe"),Te.id="ytplayeriframe",Te.type="text/html",Te.src=`https://www.youtube-nocookie.com/embed/${je}?si=RW9jDGDcqqPgCgr6$?autoplay=0&rel=0&playsinline=1&keyboard=0&iv_load_policy=3&fs=0&controls=0&mute=0&enablejsapi=1&showinfo=0&modestbranding=1`,Te.allow="accelerometer; autoplay;",Te.style.width="100vw",Te.style.height="100vh",Te.style.position="absolute",Te.style.border="none",Te.style.zIndex=2;const e=document.getElementById("fullscreen-video-container"),t=document.getElementById("vimeoplayer");e.insertBefore(Te,t),e.style.zIndex=3,Ye=new YT.Player("ytplayeriframe",{}),Ye.addEventListener("onStateChange",function(t){t.data===YT.PlayerState.PLAYING&&(e.style.zIndex=-1,Ye.setVolume(100))}),document.getElementById("vimeoplayer").remove()}async function r(e){null!=we&&null!=Ie&&(U(!0),Te&&Te.parentNode&&Te.parentNode.removeChild(Te),Ye&&(Ye=null),await Ie.send({type:"broadcast",event:"private_message",payload:{user_id:Le.user.id,display_name:le,acceptedYouHostLive:!0,sent_at:(new Date).toISOString()}}));const{applicationId:t,sessionId:n,token:o}=await R("vonage-session-endpoint",{name:"Functions",role:X?"moderator":"publisher"});null==me&&z();const a=document.getElementById("layoutContainer");a.style.display="flex",Ce=[],F(t,n,o,e)}async function l(){const e=document.getElementById("layoutContainer");e.style.display="none",X?(He.forEach(async e=>await S(e,{closeYouHostLive:!0})),He=[],localStorage.setItem("YouHostLiveUserIds",null)):await Ie.send({type:"broadcast",event:"private_message",payload:{user_id:Le.user.id,closeYouHostLive:!0,sent_at:(new Date).toISOString()}}),ue.disconnect(),location.reload()}async function d(e,t=!0){return new Promise((n,o)=>{const a=document.createElement("script");a.src=te&&t?e+"?v="+(new Date).getTime():e,a.async=!0,a.onload=n,a.onerror=o,document.head.appendChild(a)})}async function u(e){return new Promise((t,n)=>{const o=document.createElement("link");o.rel="stylesheet",o.href=e+"?v="+(new Date).getTime(),o.onload=t,o.onerror=n,document.head.appendChild(o)})}async function m(e,t){const n=await A(),{data:o,error:a}=await re.auth.signInWithPassword({email:e,password:t,options:{captchaToken:n}}),s=null!=o.session;s&&i({event:"SIGNED_IN_WITH_EMAIL"})}async function y(){const{data:e,error:t}=await re.auth.getSession(),n=null!=e.session;return n&&i({event:"SIGNED_IN_WITH_CURRENT_SESSION"}),{error:t,success:n}}async function p(){const e=await R("version",{name:"Functions"});if(e.version!=W)throw alert(`Version mismatch: ${e.version} != ${W}`),new Error(`Version mismatch: ${e.version} != ${W}`);document.getElementById("version").style.display="block"}function g(){ae.innerHTML=ge?`End Live (${K})`:`Go Live (${K})`,ae.style.display="inline-block"}async function h(e=!1){if(e){const{isLive:e,youTubeVideoId:t}=await R("is-show-live-no-token",{name:"Functions",app_name:X?K:G});ge=e,je=t}else{const e=await A(),{isLive:t,youTubeVideoId:n}=await R("is-show-live",{name:"Functions",token:e,app_name:X?K:G});ge=t,je=n}X&&g(),ee&&ge&&(document.getElementById("open-you-host-live-button").style.display="inline-block",Z||c())}async function v(){ae.style.display="none";const{isLive:e}=await R("set-is-show-live",{name:"Functions",isLive:!ge,app_name:K,youTubeVideoId:je});if("boolean"!=typeof e)throw new Error(`Failed ${K} is Live...`);ge=!ge,g(),await f()}async function f(){!ge&&Object.keys(Ee).length>0&&Object.keys(Ee).forEach(async e=>{await S(e,{isLive:!1})})}async function w(){const e=await A(),{data:t,error:n}=await re.auth.signInAnonymously({options:{captchaToken:e}}),o=null!=t.session;o&&i({event:"SIGNED_IN_ANONYMOUSLY"})}async function b(e){const{data:t,error:n}=await re.storage.from("live-audience-images").download(e);if(!n)return t}function I(e){const t=Object.keys(Ee),n=document.querySelectorAll(".image-grid img");n.forEach(e=>{if(!t.includes(e.id)){const t=e.closest(".image-item");H(t),ke.delete(e.id),He=He.filter(e=>!He.includes(e)),localStorage.setItem("YouHostLiveUserIds",JSON.stringify(He))}}),e.forEach(e=>B(e))}async function L(e){if(Se.has(e))return Se.get(e);const t=await b(e),n=URL.createObjectURL(t);return Se.set(e,n),n}async function E(e){const t=document.getElementById(e).closest(".image-item");t.classList.contains("selected")?(await S(e,{declineYouHostLive:!0}),He=He.filter(t=>t!=e),localStorage.setItem("YouHostLiveUserIds",JSON.stringify(He)),t.classList.remove("selected")):(await S(e,{offerYouHostLive:!0}),He.push(e),localStorage.setItem("YouHostLiveUserIds",JSON.stringify(He)),t.classList.add("selected"))}function _(e){const t=e.payload;if("user_id"in t&&He.includes(t.user_id))if(Be)"closeYouHostLive"in t&&t.closeYouHostLive&&l();else{if(!("acceptedYouHostLive"in t))return;Be=!0,X&&(ae.style.display="none"),document.getElementById("close-you-host-live-flexbox").style.display="flex",r()}}async function S(e,t){if(!ke.has(e))return;const n=ke.get(e);try{await n.send({type:"broadcast",event:"private_message",payload:{message:t,sent_at:(new Date).toISOString()}})}catch(e){throw new Error(e)}}function k(e){if(ke.has(e))return ke.get(e);const t=re.channel(`room:${e}:messages`,{config:{private:!0,broadcast:{ack:!0}}});return t.on("broadcast",{event:"private_message"},_).subscribe(),ke.set(e,t),t}function H(e){const t=.3;e.style.transition=`opacity ${t}s ease`,e.style.opacity=0,setTimeout(()=>e.remove(),1e3*t)}function B(e){const t=se,n=document.getElementById(`${e.user_id}`);if(n)n.src=e.live_audience_image_url;else{const n=document.createElement("div");n.className="image-item",He.includes(e.user_id)&&n.classList.add("selected");const o=document.createElement("img");o.id=`${e.user_id}`,o.src=e.live_audience_image_url,o.loading="lazy",o.alt=`User ${e.user_id}`,o.title=`[ ${e.display_name} ] ${e.comment}`;const a=document.createElement("button");a.className="hover-btn",a.textContent="Live Stage",a.style="font-size: .2rem",n.appendChild(o),n.appendChild(a),t.appendChild(n)}}async function C(){be=re.channel(K,{config:{private:!1,broadcast:{self:!0,ack:!0},presence:{key:Le.user.id}}}),be.on("presence",{event:"join"},({key:e,newPresences:t})=>{Ee[e]=t[0]}).on("presence",{event:"leave"},({key:e})=>{delete Ee[e]}).on("presence",{event:"sync"},()=>{const e=be.presenceState();Object.assign(Ee,e),Object.keys(Ee).length>0&&Object.keys(Ee).forEach(e=>{k(e)}),clearTimeout(_e),_e=null,_e=setTimeout(async()=>{const t=Object.entries(e).map(async([e,[t]])=>({...t,user_id:e,live_audience_image_url:await L(t.live_audience_image)})),n=await Promise.all(t);I(n)},1e3)}).subscribe()}async function x(){try{const e=`room:${Le.user.id}:messages`;Ie=re.channel(e,{config:{private:!0,broadcast:{ack:!0}}}),be=re.channel(G,{config:{private:!1,broadcast:{self:!0,ack:!0},presence:{key:Le.user.id}}}),be.subscribe(async e=>{if("SUBSCRIBED"!==e)return;document.getElementById("camera-blur");const t=D(we),n=await Y({user_id:Le.user.id,dataURL:t.dataURL});be.track({updated_at:N(),display_name:le,live_audience_image:n,comment:de,width:t.width,height:t.height}),ce=setInterval(async function(){const e=D(we),t=await Y({user_id:Le.user.id,dataURL:e.dataURL});be.track({updated_at:N(),display_name:le,live_audience_image:t,comment:de,width:e.width,height:e.height,isFocused:!window.isBlurred})},1e4)}),Ie.on("broadcast",{event:"private_message"},e=>{"offerYouHostLive"in e.payload.message&&e.payload.message.offerYouHostLive&&gsap.set("#accept-you-host-live-flexbox",{display:"flex",top:"50%"}),"declineYouHostLive"in e.payload.message&&e.payload.message.declineYouHostLive&&gsap.set("#accept-you-host-live-flexbox",{display:"none"}),"closeYouHostLive"in e.payload.message&&e.payload.message.closeYouHostLive&&location.reload(),"isLive"in e.payload.message&&!e.payload.message.isLive&&location.reload()}).subscribe()}catch(e){}}function T(){gsap.set("#accept-you-host-live-flexbox",{display:"none"}),re.removeAllChannels()}async function Y({user_id:e,dataURL:t}){const n=j(t),o=`${O()}/${e}/${M()}.png`,{data:a,error:i}=await re.storage.from("live-audience-images").upload(o,n,{contentType:"image/png",cacheControl:"3600",upsert:!1});if(i)throw i;return o}function j(e){const t=e.split(","),n=t[0].match(/:(.*?);/)[1],o=atob(t[1]);let a=o.length;const i=new Uint8Array(a);for(;a--;)i[a]=o.charCodeAt(a);return new Blob([i],{type:n})}function D(e,t=320){const n=document.createElement("canvas");let o=e.videoWidth,a=e.videoHeight;return o>a?o>t&&(a*=t/o,o=t):a>t&&(o*=t/a,a=t),n.width=o,n.height=a,n.getContext("2d").drawImage(e,0,0,o,a),{dataURL:n.toDataURL(),width:o,height:a}}function O(e=new Date){return[String(e.getFullYear()),String(e.getMonth()+1).padStart(2,"0"),String(e.getDate()).padStart(2,"0")].join("-")}function M(e=new Date){return[String(e.getHours()).padStart(2,"0"),String(e.getMinutes()).padStart(2,"0"),String(e.getSeconds()).padStart(2,"0")].join("-")}function N(e=new Date){return[String(e.getHours()).padStart(2,"0"),String(e.getMinutes()).padStart(2,"0"),String(e.getSeconds()).padStart(2,"0")].join(":")}function A(){return new Promise((e,t)=>{const n=(Date.now()-ve)/1e3;if(n>300||null==fe){null!=fe&&(he?turnstile.reset():he=!0);const n=document.getElementById("turnstile-container");n.innerHTML="",turnstile.render("#turnstile-container",{sitekey:"0x4AAAAAAB58hE2F_vwmF7sB",callback:async function(t){ve=Date.now(),fe=t,e(t)},"error-callback":function(e){t(e)}})}else e(fe)})}async function $(){return new Promise(async(e,t)=>{const n=document.getElementById("text-name").value,o=document.getElementById("textarea-comment").value;if(""==n||""==o)throw alert("Both inputs are required."),t("Both inputs are required."),Error("Both inputs are required.");le=n,de=o,null==Le&&await w();const a=await J();if(!a)throw Error("Failed Live Audience Agreement");let i;navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({video:!0}).then(function(t){t.getVideoTracks()[0].getSettings().deviceId;const n=document.getElementById("camera-select");navigator.mediaDevices.enumerateDevices().then(e=>{const t=e.filter(e=>"videoinput"===e.kind);n.innerHTML=t.map(e=>`<option value="${e.deviceId}">${e.label||"Camera"}</option>`).join("")}),n.onchange=(async()=>{i&&i.getTracks().forEach(e=>e.stop());const e={video:{deviceId:{exact:n.value}}};i=await navigator.mediaDevices.getUserMedia(e),we.srcObject=i}),we.srcObject=t,e(t)}).catch(function(e){alert("Camera access denied."),t(e)}):(alert("Camera not supported in this browser."),t("Camera not supported in this browser."))})}function U(e=!1){e||T(),clearInterval(ce);const t=we.srcObject;if(t){const e=t.getTracks();e.forEach(e=>e.stop()),we.srcObject=null}}async function R(e,t){const{data:n,error:o}=await re.functions.invoke(e,{body:t});return n}function P(e){e&&alert(e.message)}function z(){if(ye=document.getElementById("layoutContainer"),null!=me)return{_layoutEl:ye,_layout:me};me=initLayoutContainer(ye,{fixedRatio:!1,minRatio:9/16,maxRatio:16/9,scaleLastRow:!1,alignItems:"center"}).layout,window.addEventListener("resize",()=>me())}function F(e,t,n,o){ue=OT.initSession(e,t),ue.on("streamCreated",function(e){const t=ue.subscribe(e.stream,ye,{insertMode:"append",width:"100%",height:"100%",fixedRatio:!1},P);t.on("videoElementCreated",function(e){X&&(e.element.style.backgroundColor="#00B140")}),Ce.push(t),me()}),ue.on("streamDestroyed",function(e){e.stream.destroy(),me(),alert("Stream Destroyed."),location.reload()}),ue.on("streamPropertyChanged",e=>{"videoDimensions"===e.changedProperty&&me()}),ue.on("sessionDisconnected",e=>{Ce.forEach(e=>e.destroy()),Ce.length=0,ye.innerHTML="",me()});let a={insertMode:"append",width:"100%",height:"100%"};ee&&(a.videoSource=document.getElementById("camera-select").value);const i=OT.initPublisher(ye,a,P);i.on("videoElementCreated",e=>{}),me(),ue.connect(n,function(e){e?P(e):ue.publish(i,P)})}async function J(){try{const e=document.getElementById("agreement").innerHTML,{data:t,error:n}=await re.functions.invoke("live-audience-agreement",{body:{name:"Functions",user_id:Le.user.id,agreement:e,app_name:G}});if(n)throw n;return t}catch(e){throw new Error(e)}}async function V(){const{error:e}=await sb.auth.signOut()}const W="0.1.9-beta",G=t(),q=["livehotseat","youhost"],X=q.includes(G),Z=n(),Q=["polrized","weekdaze"],K="weekdaze",ee=Q.includes(G),te=window.location.hostname.includes(".wstd.io"),ne="https://edfgdkdaurrrygzyfiyc.supabase.co",oe="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZmdka2RhdXJycnlnenlmaXljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NDczNzgsImV4cCI6MjA3MTQyMzM3OH0.AWa3MC8T7nPYukDU7BI5yc9BOe5XbKCMV_1-R8RI6ZE",ae=document.getElementById("live-button"),ie=document.getElementById("audience-toggle"),se=document.querySelector(".image-grid");let ce,re,le,de,ue,me,ye,pe=!1,ge=null,he=!1,ve=null,fe=null,we=null,be=null,Ie=null,Le=null,Ee={},_e=null,Se=new Map,ke=new Map,He=[],Be=!1,Ce=[],xe=null,Te=null,Ye=null,je=null,De=3,Oe=()=>{const e=document.getElementById("loading-text");switch(De+=1,De){case 1:e.innerHTML="Loading.";break;case 2:e.innerHTML="Loading..";break;case 3:e.innerHTML="Loading...";break;default:e.innerHTML="Loading",De=0}},Me=setInterval(Oe,1e3);Oe();let Ne={init:e,subscribe:s,startLiveAudience:$,stopLiveAudience:U,startYouHostLive:r,stopYouHostLive:l,offerYouHostLive:E,signOut:V};return X&&(Ne.offerYouHostLive=E,Ne.loginWithEmail=m),Ne}();window.YouHostLive=YouHostLive;