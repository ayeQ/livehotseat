const YouHostLive=function(){async function e(){if(ge)return;ge=!0,n(),i(),await Promise.all([l("https://apis.google.com/js/platform.js",null),l("https://www.youtube.com/iframe_api",null),l("https://challenges.cloudflare.com/turnstile/v0/api.js",null),l("https://unpkg.com/@supabase/supabase-js@2.43.3/dist/umd/supabase.js",null),l("https://unpkg.com/gsap@3/dist/gsap.min.js",null),l("https://unpkg.com/gsap@3/dist/TextPlugin.min.js",null),l("https://unpkg.com/gsap@3/dist/SplitText.min.js",null),l("https://unpkg.com/@vonage/client-sdk-video@2/dist/js/opentok.js",null),l("https://unpkg.com/opentok-layout-js@5.5.0/opentok-layout.js",null),l(`https://youhostlive.nightowllogic.com/${te?X:X+""}.js`,!0),d("https://youhostlive.nightowllogic.com/common.css"),d(`https://youhostlive.nightowllogic.com/${X}.css`)]),le=window.supabase.createClient(ne,ie);const e=document.createElement("div");e.id="turnstile-container",document.body.appendChild(e);const t=document.createElement("div");if(t.id="version",t.style.display="none",t.innerHTML=G,document.body.appendChild(t),await p(),le.auth.onAuthStateChange(async(e,t)=>{switch(e){case"INITIAL_SESSION":const{error:n,success:i}=await m();if(n)throw n;i?(Ee=t,g(),await h(!0)):Ee=null,Z&&(i?await T():document.getElementById("sign-in-flexbox").style.display="flex"),ee&&(i||(await h(),we=null));break;case"SIGNED_IN":Ee=t,Z&&null==Le&&(g(),await h(!0),await T())}}),ee){document.getElementById("text-name").setAttribute("maxlength","25"),document.getElementById("textarea-comment").setAttribute("maxlength","130"),be=document.createElement("video"),be.id="user-camera-live-audience-video",be.style.width="160px",be.style.height="160px",be.style.borderRadius="6px",be.style.background="#000",be.style.display="block",be.style.objectFit="cover",be.autoplay=!0,be.playsInline=!0,be.addEventListener("loadeddata",async function(){o({event:"SIGNED_IN_WITH_EMAIL"}),await C()});const e=document.getElementById("live-audience-body"),t=document.getElementById("sign-out-camera-button");e.insertBefore(be,t)}Z&&(ae.addEventListener("mouseup",async()=>{await v()}),ce.style.display="checked"==ce.dataset.state?"flex":"none",se.addEventListener("mouseup",async e=>{switch(e.target.dataset.state){case"unchecked":ce.style.display="none";break;case"checked":ce.style.display="flex"}})),window.addEventListener("blur",()=>_isBlurred=!0),window.addEventListener("focus",()=>_isBlurred=!1);const a=document.createElement("div");a.id="layoutContainer",document.body.appendChild(a),clearInterval($e),document.getElementById("loading-dialog").style.display="none",document.getElementById("loading-text").innerHTML="Loading...",o({event:"READY"})}function t(){const e=document.currentScript,t=new URL(e.src),n=new URLSearchParams(t.search),i=n.get("app");return i}function n(){}function i(){if(!ee&&!Z)throw new Error("You Host Live App Website Permission Error.");const e=te?`https://${X}com.wstd.io`:`https://www.${X}.com`,t=te?`https://${X}live.wstd.io`:`https://www.${X}.live`;if(window.location.origin!=e&&window.location.origin!=t)throw new Error("You Host Live App Website Permission Error.")}function o(e){"function"==typeof je&&je(e)}function a(e){je=e}function s(){if(!he)return;gsap.set("#welcome-dialog",{display:"flex"}),document.getElementById("open-you-host-live-button").style.display="inline-block",Me=document.createElement("iframe"),Me.id="ytplayeriframe",Me.type="text/html",Me.allow="accelerometer; autoplay;",Me.src=`https://www.youtube-nocookie.com/embed/${De}?autoplay=1&rel=0&playsinline=1&keyboard=0&iv_load_policy=3&fs=0&controls=0&mute=1&enablejsapi=1&showinfo=0&modestbranding=1`,Me.style.width="100vw",Me.style.height="100vh",Me.style.position="absolute",Me.style.border="none",Me.style.zIndex=-1;const e=document.getElementById("fullscreen-video-container"),t=document.getElementById("vimeoplayer");e.insertBefore(Me,t),e.style.zIndex=3,Ye=new YT.Player("ytplayeriframe",{}),Ye.addEventListener("onStateChange",function(t){t.data===YT.PlayerState.PLAYING&&(e.style.zIndex=-1)}),document.getElementById("vimeoplayer").remove()}async function c(e){null!=be&&null!=Ie&&(R(!0),Me&&Me.parentNode&&Me.parentNode.removeChild(Me),Ye&&(Ye=null),await Ie.send({type:"broadcast",event:"private_message",payload:{user_id:Ee.user.id,display_name:de,acceptedYouHostLive:!0,sent_at:(new Date).toISOString()}}));const{applicationId:t,sessionId:n,token:i}=await U("vonage-session-endpoint",{name:"Functions",role:Z?"moderator":"publisher"});null==pe&&z();const o=document.getElementById("layoutContainer");o.style.display="flex",Ce=[],F(t,n,i,e),Te=!0,Z&&g()}async function r(){const e=document.getElementById("layoutContainer");e.style.display="none",Z?(He.forEach(async e=>await k(e,{closeYouHostLive:!0})),He=[]):await Ie.send({type:"broadcast",event:"private_message",payload:{user_id:Ee.user.id,closeYouHostLive:!0,sent_at:(new Date).toISOString()}}),me.disconnect(),location.reload()}async function l(e,t=!1){return new Promise((n,i)=>{const o=document.createElement("script");o.src=null!=t&&(te||t)?e+"?v="+(new Date).getTime():e,o.async=!0,o.onload=n,o.onerror=i,document.head.appendChild(o)})}async function d(e){return new Promise((t,n)=>{const i=document.createElement("link");i.rel="stylesheet",i.href=e+"?v="+(new Date).getTime(),i.onload=t,i.onerror=n,document.head.appendChild(i)})}async function u(e,t){const n=await $(),{data:i,error:a}=await le.auth.signInWithPassword({email:e,password:t,options:{captchaToken:n}}),s=null!=i.session;s&&o({event:"SIGNED_IN_WITH_EMAIL"})}async function m(){const{data:e,error:t}=await le.auth.getSession(),n=null!=e.session;return n&&o({event:"SIGNED_IN_WITH_CURRENT_SESSION"}),{error:t,success:n}}async function p(){const e=await U("version",{name:"Functions"});if(e.version!=G)throw alert(`Version mismatch: ${e.version} != ${G}`),new Error(`Version mismatch: ${e.version} != ${G}`);document.getElementById("version").style.display="block"}function y(){ae.innerHTML=he?`End Live (${K})`:`Go Live (${K})`,ae.style.display="inline-block"}function g(){oe.innerHTML=Te?"End Live Stage":"Join Live Stage",oe.style.display="inline-block"}async function h(e=!1){if(e){const{isLive:e,youTubeVideoId:t}=await U("is-show-live-no-token",{name:"Functions",app_name:Z?K:X});he=e,De=t}else{const e=await $(),{isLive:t,youTubeVideoId:n}=await U("is-show-live",{name:"Functions",token:e,app_name:Z?K:X});he=t,De=n}Z&&y()}async function v(){ae.style.display="none";const{isLive:e}=await U("set-is-show-live",{name:"Functions",isLive:!he,app_name:K,youTubeVideoId:De});if("boolean"!=typeof e)throw new Error(`Failed ${K} is Live...`);he=!he,y(),await f()}async function f(){!he&&Object.keys(_e).length>0&&Object.keys(_e).forEach(async e=>{await k(e,{isLive:!1})})}async function w(){const e=await $(),{data:t,error:n}=await le.auth.signInAnonymously({options:{captchaToken:e}}),i=null!=t.session;i&&o({event:"SIGNED_IN_ANONYMOUSLY"})}async function b(e){const{data:t,error:n}=await le.storage.from("live-audience-images").download(e);if(!n)return t}function L(e){const t=Object.keys(_e),n=document.querySelectorAll(".image-grid img");n.forEach(e=>{if(!t.includes(e.id)){const t=e.closest(".image-item");B(t),Be.delete(e.id),He=He.filter(t=>t!=e.id)}}),e.forEach(e=>H(e))}async function I(e){if(Se.has(e))return Se.get(e);const t=await b(e),n=URL.createObjectURL(t);return Se.set(e,n),n}async function E(e){const t=document.getElementById(e).closest(".image-item");t.classList.contains("selected")?(He=He.filter(t=>t!=e),t.classList.remove("selected"),xe.includes(e)?(xe=xe.filter(t=>t!=e),await k(e,{closeYouHostLive:!0})):await k(e,{declineYouHostLive:!0})):(await k(e,{offerYouHostLive:!0}),He.push(e),t.classList.add("selected"))}function _(e){const t=e.payload;if("user_id"in t&&He.includes(t.user_id))if(Te){if("closeYouHostLive"in t&&t.closeYouHostLive&&r(),!("acceptedYouHostLive"in t))return;xe.push(t.user_id)}else{if(!("acceptedYouHostLive"in t))return;xe.push(t.user_id),oe.innerHTML="End Live Stage",c()}}async function k(e,t){if(!Be.has(e))return;const n=Be.get(e);try{await n.send({type:"broadcast",event:"private_message",payload:{message:t,sent_at:(new Date).toISOString()}})}catch(e){throw new Error(e)}}function S(e){if(Be.has(e))return Be.get(e);const t=le.channel(`room:${e}:messages`,{config:{private:!0,broadcast:{ack:!0}}});return t.on("broadcast",{event:"private_message"},_).subscribe(),Be.set(e,t),t}function B(e){const t=.3;e.style.transition=`opacity ${t}s ease`,e.style.opacity=0,setTimeout(()=>e.remove(),1e3*t)}function H(e){const t=ce,n=document.getElementById(`${e.user_id}`);if(n)n.src=e.live_audience_image_url;else{const n=document.createElement("div");n.className="image-item",He.includes(e.user_id)&&n.classList.add("selected");const i=document.createElement("img");i.id=`${e.user_id}`,i.src=e.live_audience_image_url,i.loading="lazy",i.alt=`User ${e.user_id}`,i.title=`[ ${e.display_name} ] ${e.comment}`;const o=document.createElement("button");o.className="hover-btn",o.textContent="Live Stage",o.style="font-size: .2rem",n.appendChild(i),n.appendChild(o),t.appendChild(n)}}async function T(){Le=le.channel(K,{config:{private:!1,broadcast:{self:!0,ack:!0},presence:{key:Ee.user.id}}}),Le.on("presence",{event:"join"},({key:e,newPresences:t})=>{_e[e]=t[0]}).on("presence",{event:"leave"},({key:e})=>{delete _e[e]}).on("presence",{event:"sync"},()=>{const e=Le.presenceState();Object.assign(_e,e),Object.keys(_e).length>0&&Object.keys(_e).forEach(e=>{S(e)}),clearTimeout(ke),ke=null,ke=setTimeout(async()=>{const t=Object.entries(e).map(async([e,[t]])=>({...t,user_id:e,live_audience_image_url:await I(t.live_audience_image)})),n=await Promise.all(t);L(n)},1e3)}).subscribe()}async function C(){try{const e=`room:${Ee.user.id}:messages`;Ie=le.channel(e,{config:{private:!0,broadcast:{ack:!0}}}),Le=le.channel(X,{config:{private:!1,broadcast:{self:!0,ack:!0},presence:{key:Ee.user.id}}}),Le.subscribe(async e=>{if("SUBSCRIBED"!==e)return;document.getElementById("camera-blur");const t=Y(be),n=await j({user_id:Ee.user.id,dataURL:t.dataURL});Le.track({updated_at:A(),display_name:de,live_audience_image:n,comment:ue,width:t.width,height:t.height}),re=setInterval(async function(){const e=Y(be),t=await j({user_id:Ee.user.id,dataURL:e.dataURL});Le.track({updated_at:A(),display_name:de,live_audience_image:t,comment:ue,width:e.width,height:e.height,isFocused:!window.isBlurred})},1e4)}),Ie.on("broadcast",{event:"private_message"},e=>{"offerYouHostLive"in e.payload.message&&e.payload.message.offerYouHostLive&&gsap.set("#accept-you-host-live-flexbox",{display:"flex",top:"50%"}),"declineYouHostLive"in e.payload.message&&e.payload.message.declineYouHostLive&&gsap.set("#accept-you-host-live-flexbox",{display:"none"}),"closeYouHostLive"in e.payload.message&&e.payload.message.closeYouHostLive&&location.reload(),"isLive"in e.payload.message&&!e.payload.message.isLive&&location.reload()}).subscribe()}catch(e){}}function x(){gsap.set("#accept-you-host-live-flexbox",{display:"none"}),le.removeAllChannels()}async function j({user_id:e,dataURL:t}){const n=M(t),i=`${D()}/${e}/${O()}.png`,{data:o,error:a}=await le.storage.from("live-audience-images").upload(i,n,{contentType:"image/png",cacheControl:"3600",upsert:!1});if(a)throw a;return i}function M(e){const t=e.split(","),n=t[0].match(/:(.*?);/)[1],i=atob(t[1]);let o=i.length;const a=new Uint8Array(o);for(;o--;)a[o]=i.charCodeAt(o);return new Blob([a],{type:n})}function Y(e,t=320){const n=document.createElement("canvas");let i=e.videoWidth,o=e.videoHeight;return i>o?i>t&&(o*=t/i,i=t):o>t&&(i*=t/o,o=t),n.width=i,n.height=o,n.getContext("2d").drawImage(e,0,0,i,o),{dataURL:n.toDataURL(),width:i,height:o}}function D(e=new Date){return[String(e.getFullYear()),String(e.getMonth()+1).padStart(2,"0"),String(e.getDate()).padStart(2,"0")].join("-")}function O(e=new Date){return[String(e.getHours()).padStart(2,"0"),String(e.getMinutes()).padStart(2,"0"),String(e.getSeconds()).padStart(2,"0")].join("-")}function A(e=new Date){return[String(e.getHours()).padStart(2,"0"),String(e.getMinutes()).padStart(2,"0"),String(e.getSeconds()).padStart(2,"0")].join(":")}function $(){return new Promise((e,t)=>{const n=(Date.now()-fe)/1e3;if(n>300||null==we){null!=we&&(ve?turnstile.reset():ve=!0);const n=document.getElementById("turnstile-container");n.innerHTML="",turnstile.render("#turnstile-container",{sitekey:"0x4AAAAAAB58hE2F_vwmF7sB",callback:async function(t){fe=Date.now(),we=t,e(t)},"error-callback":function(e){t(e)}})}else e(we)})}async function N(){return new Promise(async(e,t)=>{const n=document.getElementById("text-name").value,i=document.getElementById("textarea-comment").value;if(""==n||""==i)throw alert("Both inputs are required."),t("Both inputs are required."),Error("Both inputs are required.");de=n,ue=i,null==Ee&&await w();const o=await V();if(!o)throw Error("Failed Live Audience Agreement");let a;navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({video:!0}).then(function(t){t.getVideoTracks()[0].getSettings().deviceId;const n=document.getElementById("camera-select");navigator.mediaDevices.enumerateDevices().then(e=>{const t=e.filter(e=>"videoinput"===e.kind);n.innerHTML=t.map(e=>`<option value="${e.deviceId}">${e.label||"Camera"}</option>`).join("")}),n.onchange=(async()=>{a&&a.getTracks().forEach(e=>e.stop());const e={video:{deviceId:{exact:n.value}}};a=await navigator.mediaDevices.getUserMedia(e),be.srcObject=a}),be.srcObject=t,e(t)}).catch(function(e){alert("Camera access denied."),t(e)}):(alert("Camera not supported in this browser."),t("Camera not supported in this browser."))})}function R(e=!1){e||x(),clearInterval(re);const t=be.srcObject;if(t){const e=t.getTracks();e.forEach(e=>e.stop()),be.srcObject=null}}async function U(e,t){const{data:n,error:i}=await le.functions.invoke(e,{body:t});return n}function P(e){e&&alert(e.message)}function z(){if(ye=document.getElementById("layoutContainer"),null!=pe)return{_layoutEl:ye,_layout:pe};pe=initLayoutContainer(ye,{fixedRatio:!1,minRatio:9/16,maxRatio:16/9,scaleLastRow:!1,alignItems:"center"}).layout,window.addEventListener("resize",()=>pe())}function F(e,t,n,i){me=OT.initSession(e,t),me.on("streamCreated",function(e){const t=me.subscribe(e.stream,ye,{insertMode:"append",width:"100%",height:"100%",fixedRatio:!1},P);t.on("videoElementCreated",function(e){Z&&(e.element.style.backgroundColor="#00B140")}),Ce.push(t),pe()}),me.on("streamDestroyed",function(e){e.stream.destroy(),pe()}),me.on("streamPropertyChanged",e=>{"videoDimensions"===e.changedProperty&&pe()}),me.on("sessionDisconnected",e=>{Ce.forEach(e=>e.destroy()),Ce.length=0,ye.innerHTML="",pe()});let o={insertMode:"append",width:"100%",height:"100%"};ee&&(o.videoSource=document.getElementById("camera-select").value);const a=OT.initPublisher(ye,o,P);a.on("videoElementCreated",e=>{}),pe(),me.connect(n,function(e){e?P(e):me.publish(a,P)})}async function V(){try{const e=document.getElementById("agreement").innerHTML,{data:t,error:n}=await le.functions.invoke("live-audience-agreement",{body:{name:"Functions",user_id:Ee.user.id,agreement:e,app_name:X}});if(n)throw n;return t}catch(e){throw new Error(e)}}async function J(){const{error:e}=await sb.auth.signOut()}function W(){Ye.unMute(),Ye.setVolume(100)}const G="0.1.9-beta",X=t(),q=["livehotseat","youhost"],Z=q.includes(X),Q=["polrized","weekdaze"],K="polrized",ee=Q.includes(X),te=window.location.hostname.includes(".wstd.io"),ne="https://edfgdkdaurrrygzyfiyc.supabase.co",ie="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZmdka2RhdXJycnlnenlmaXljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NDczNzgsImV4cCI6MjA3MTQyMzM3OH0.AWa3MC8T7nPYukDU7BI5yc9BOe5XbKCMV_1-R8RI6ZE",oe=document.getElementById("close-you-host-live-button"),ae=document.getElementById("live-button"),se=document.getElementById("audience-toggle"),ce=document.querySelector(".image-grid");let re,le,de,ue,me,pe,ye,ge=!1,he=null,ve=!1,fe=null,we=null,be=null,Le=null,Ie=null,Ee=null,_e={},ke=null,Se=new Map,Be=new Map,He=[],Te=!1,Ce=[],xe=[],je=null,Me=null,Ye=null,De=null,Oe=3,Ae=()=>{const e=document.getElementById("loading-text");switch(Oe+=1,Oe){case 1:e.innerHTML="Loading.";break;case 2:e.innerHTML="Loading..";break;case 3:e.innerHTML="Loading...";break;default:e.innerHTML="Loading",Oe=0}},$e=setInterval(Ae,1e3);Ae();let Ne={unMute:W,init:e,subscribe:a,renderLiveStreamOnClient:s,startLiveAudience:N,stopLiveAudience:R,startYouHostLive:c,stopYouHostLive:r,offerYouHostLive:E,signOut:J};return Z&&(Ne.offerYouHostLive=E,Ne.loginWithEmail=u),Ne}();window.YouHostLive=YouHostLive;