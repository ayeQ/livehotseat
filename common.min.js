const LiveHotSeat=function(){async function e(){if(ue)return;ue=!0,n(),a(),await Promise.all([l("https://www.youtube.com/iframe_api",!1),l("https://challenges.cloudflare.com/turnstile/v0/api.js",!1),l("https://unpkg.com/@supabase/supabase-js@2.43.3/dist/umd/supabase.js",!1),l("https://unpkg.com/gsap@3/dist/gsap.min.js",!1),l("https://unpkg.com/gsap@3/dist/TextPlugin.min.js",!1),l("https://unpkg.com/gsap@3/dist/SplitText.min.js",!1),l("https://unpkg.com/@vonage/client-sdk-video@2/dist/js/opentok.js",!1),l("https://unpkg.com/opentok-layout-js@5.5.0/opentok-layout.js",!1),l(`https://livehotseat.nightowllogic.com/${K?G:G+".min"}.js`,!0),d("https://livehotseat.nightowllogic.com/common.css"),d(`https://livehotseat.nightowllogic.com/${G}.css`)]),ie=window.supabase.createClient(ee,te);const e=document.createElement("div");e.id="turnstile-container",document.body.appendChild(e);const t=document.createElement("div");if(t.id="version",t.style.display="none",t.innerHTML=W,document.body.appendChild(t),await y(),ie.auth.onAuthStateChange(async(e,t)=>{switch(e){case"INITIAL_SESSION":const{error:n,success:a}=await m();if(n)throw n;a?(we=t,await g(!0)):we=null,q&&(a?await H():document.getElementById("sign-in-flexbox").style.display="flex"),Q&&(a||(await g(),ge=null));break;case"SIGNED_IN":we=t,q&&null==he&&(await g(!0),await H())}}),Q){document.getElementById("text-name").setAttribute("maxlength","25"),document.getElementById("textarea-comment").setAttribute("maxlength","130"),ve=document.createElement("video"),ve.id="user-camera-live-audience-video",ve.style.width="160px",ve.style.height="160px",ve.style.borderRadius="6px",ve.style.background="#000",ve.style.display="block",ve.style.objectFit="cover",ve.autoplay=!0,ve.playsInline=!0,ve.addEventListener("loadeddata",async function(){i({event:"SIGNED_IN_WITH_EMAIL"}),await C()});const e=document.getElementById("live-audience-body"),t=document.getElementById("sign-out-camera-button");e.insertBefore(ve,t)}q&&ne.addEventListener("mouseup",async()=>{await v()}),window.addEventListener("blur",()=>_isBlurred=!0),window.addEventListener("focus",()=>_isBlurred=!1);const o=document.createElement("div");o.id="layoutContainer",document.body.appendChild(o),clearInterval(De),document.getElementById("loading-dialog").style.display="none",document.getElementById("loading-text").innerHTML="Loading...",i({event:"READY"})}function t(){const e=document.currentScript,t=new URL(e.src),n=new URLSearchParams(t.search),a=n.get("app");return a}function n(){const e=localStorage.getItem("LiveHotSeatUserId");null!=e&&(Ee=e)}function a(){if(!Q&&!q)throw new Error("Live Hot Seat App Website Permission Error.");const e=K?`https://${G}com.wstd.io`:`https://www.${G}.com`;if(window.location.origin!=e)throw new Error("Live Hot Seat App Website Permission Error.")}function i(e){"function"==typeof Be&&Be(e)}function o(e){Be=e}function s(){He=document.createElement("iframe"),He.id="ytplayeriframe",He.type="text/html",He.src=`https://www.youtube-nocookie.com/embed/${Te}?autoplay=0&rel=0&playsinline=1&keyboard=0&iv_load_policy=3&fs=0&controls=0&mute=0&enablejsapi=1&showinfo=0&modestbranding=1`,He.style.width="100vw",He.style.height="100vh",He.style.position="absolute",He.style.border="none",He.style.zIndex=2;const e=document.getElementById("fullscreen-video-container"),t=document.getElementById("vimeoplayer");e.insertBefore(He,t),e.style.zIndex=3,Ce=new YT.Player("ytplayeriframe",{}),Ce.addEventListener("onStateChange",function(t){t.data===YT.PlayerState.PLAYING&&(e.style.zIndex=-1,Ce.setVolume(100))}),document.getElementById("vimeoplayer").remove()}async function r(){null!=ve&&null!=fe&&(N(!0),He&&He.parentNode&&He.parentNode.removeChild(He),Ce&&(Ce=null),await fe.send({type:"broadcast",event:"private_message",payload:{user_id:we.user.id,display_name:oe,acceptedLiveHotSeat:!0,sent_at:(new Date).toISOString()}}));const{applicationId:e,sessionId:t,token:n}=await R("vonage-session-endpoint",{name:"Functions",role:q?"moderator":"publisher"});null==le&&z();const a=document.getElementById("layoutContainer");a.style.display="flex",ke=[],F(e,t,n)}async function c(){const e=document.getElementById("layoutContainer");e.style.display="none",q?(await E(Ee,{closeLiveHotSeat:!0}),Ee=null,localStorage.setItem("LiveHotSeatUserId",null)):await fe.send({type:"broadcast",event:"private_message",payload:{user_id:we.user.id,closeLiveHotSeat:!0,sent_at:(new Date).toISOString()}}),ce.disconnect(),location.reload()}async function l(e,t=!0){return new Promise((n,a)=>{const i=document.createElement("script");i.src=K&&t?e+"?v="+(new Date).getTime():e,i.async=!0,i.onload=n,i.onerror=a,document.head.appendChild(i)})}async function d(e){return new Promise((t,n)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=e+"?v="+(new Date).getTime(),a.onload=t,a.onerror=n,document.head.appendChild(a)})}async function u(e,t){const n=await U(),{data:a,error:o}=await ie.auth.signInWithPassword({email:e,password:t,options:{captchaToken:n}}),s=null!=a.session;s&&i({event:"SIGNED_IN_WITH_EMAIL"})}async function m(){const{data:e,error:t}=await ie.auth.getSession(),n=null!=e.session;return n&&i({event:"SIGNED_IN_WITH_CURRENT_SESSION"}),{error:t,success:n}}async function y(){const e=await R("version",{name:"Functions"});e.version!=W&&(alert(`Version mismatch: ${e.version} != ${W}`),location.reload(!0)),document.getElementById("version").style.display="block"}function p(){ne.innerHTML=me?`End Live (${Z})`:`Go Live (${Z})`,ne.style.backgroundColor=me?"red":"rgb(222, 226, 230)",ne.style.display="inline-block"}async function g(e=!1){if(e){const{isLive:e,youTubeVideoId:t}=await R("is-show-live-no-token",{name:"Functions",app_name:q?Z:G});me=e,Te=t}else{const e=await U(),{isLive:t,youTubeVideoId:n}=await R("is-show-live",{name:"Functions",token:e,app_name:q?Z:G});me=t,Te=n}q&&p(),Q&&me&&(document.getElementById("open-live-hot-seat-button").style.display="inline-block",s())}async function v(){ne.style.display="none";const{isLive:e}=await R("set-is-show-live",{name:"Functions",isLive:!me,app_name:Z,youTubeVideoId:Te});if("boolean"!=typeof e)throw new Error(`Failed ${Z} is Live...`);me=!me,p(),await h()}async function h(){!me&&Object.keys(be).length>0&&Object.keys(be).forEach(async e=>{await E(e,{isLive:!1})})}async function f(){const e=await U(),{data:t,error:n}=await ie.auth.signInAnonymously({options:{captchaToken:e}}),a=null!=t.session;a&&i({event:"SIGNED_IN_ANONYMOUSLY"})}async function w(e){const{data:t,error:n}=await ie.storage.from("live-audience-images").download(e);if(!n)return t}function b(e){const t=Object.keys(be),n=document.querySelectorAll(".image-grid img");n.forEach(e=>{if(!t.includes(e.id)){const t=e.closest(".image-item");k(t),Le.delete(e.id),e.id==Ee&&(Ee=null,localStorage.setItem("LiveHotSeatUserId",null))}}),e.forEach(e=>B(e))}async function I(e){if(Se.has(e))return Se.get(e);const t=await w(e),n=URL.createObjectURL(t);return Se.set(e,n),n}async function S(e){const t=document.getElementById(e).closest(".image-item");t.classList.contains("selected")?(await E(e,{declineLiveHotSeat:!0}),Ee=null,localStorage.setItem("LiveHotSeatUserId",null),t.classList.remove("selected")):(await E(e,{offerLiveHotSeat:!0}),Ee=e,localStorage.setItem("LiveHotSeatUserId",Ee),t.classList.add("selected"))}function L(e){const t=e.payload;if("user_id"in t&&Ee==t.user_id)if(_e)"closeLiveHotSeat"in t&&t.closeLiveHotSeat&&c();else{if(!("acceptedLiveHotSeat"in t))return;_e=!0,re=t.filter,q&&(ne.style.display="none"),document.querySelector(".image-grid").style.display="none",document.getElementById("heading-image-grid").style.display="none",document.getElementById("close-live-hot-seat-flexbox").style.display="flex",r()}}async function E(e,t){if(!Le.has(e))return;const n=Le.get(e);try{await n.send({type:"broadcast",event:"private_message",payload:{message:t,sent_at:(new Date).toISOString()}})}catch(e){throw new Error(e)}}function _(e){if(Le.has(e))return Le.get(e);const t=ie.channel(`room:${e}:messages`,{config:{private:!0,broadcast:{ack:!0}}});return t.on("broadcast",{event:"private_message"},L).subscribe(),Le.set(e,t),t}function k(e){const t=.3;e.style.transition=`opacity ${t}s ease`,e.style.opacity=0,setTimeout(()=>e.remove(),1e3*t)}function B(e){const t=document.getElementsByClassName("image-grid")[0],n=document.getElementById(`${e.user_id}`);if(n)n.src=e.live_audience_image_url,n.style.filter=e.filter;else{const n=document.createElement("div");n.className="image-item",e.user_id==Ee&&n.classList.add("selected");const a=document.createElement("img");a.id=`${e.user_id}`,a.src=e.live_audience_image_url,a.loading="lazy",a.alt=`User ${e.user_id}`,a.title=`[ ${e.display_name} ] ${e.comment}`,a.style.filter=e.filter;const i=document.createElement("button");i.className="hover-btn",i.textContent="Live Hot Seat",i.style="font-size: .2rem",n.appendChild(a),n.appendChild(i),t.appendChild(n)}}async function H(){he=ie.channel(Z,{config:{private:!1,broadcast:{self:!0,ack:!0},presence:{key:we.user.id}}}),he.on("presence",{event:"join"},({key:e,newPresences:t})=>{be[e]=t[0]}).on("presence",{event:"leave"},({key:e})=>{delete be[e]}).on("presence",{event:"sync"},()=>{const e=he.presenceState();Object.assign(be,e),Object.keys(be).length>0&&Object.keys(be).forEach(e=>{_(e)}),clearTimeout(Ie),Ie=null,_e||(Ie=setTimeout(async()=>{const t=Object.entries(e).map(async([e,[t]])=>({...t,user_id:e,live_audience_image_url:await I(t.live_audience_image)})),n=await Promise.all(t);b(n)},1e3))}).subscribe()}async function C(){try{const e=`room:${we.user.id}:messages`;fe=ie.channel(e,{config:{private:!0,broadcast:{ack:!0}}}),he=ie.channel(G,{config:{private:!1,broadcast:{self:!0,ack:!0},presence:{key:we.user.id}}}),he.subscribe(async e=>{if("SUBSCRIBED"!==e)return;const t=document.getElementById("camera-blur"),n=D(ve),a=await x({user_id:we.user.id,dataURL:n.dataURL});he.track({updated_at:O(),display_name:oe,live_audience_image:a,comment:se,width:n.width,height:n.height,filter:`blur(${t.value}px)`}),ae=setInterval(async function(){const e=D(ve),n=await x({user_id:we.user.id,dataURL:e.dataURL});he.track({updated_at:O(),display_name:oe,live_audience_image:n,comment:se,width:e.width,height:e.height,isFocused:!window.isBlurred,filter:`blur(${t.value}px)`})},1e4)}),fe.on("broadcast",{event:"private_message"},e=>{"offerLiveHotSeat"in e.payload.message&&e.payload.message.offerLiveHotSeat&&gsap.set("#accept-live-hot-seat-flexbox",{display:"flex",top:"50%"}),"declineLiveHotSeat"in e.payload.message&&e.payload.message.declineLiveHotSeat&&gsap.set("#accept-live-hot-seat-flexbox",{display:"none"}),"closeLiveHotSeat"in e.payload.message&&e.payload.message.closeLiveHotSeat&&location.reload(),"isLive"in e.payload.message&&!e.payload.message.isLive&&location.reload()}).subscribe()}catch(e){}}function T(){gsap.set("#accept-live-hot-seat-flexbox",{display:"none"}),ie.removeAllChannels()}async function x({user_id:e,dataURL:t}){const n=j(t),a=`${M()}/${e}/${A()}.png`,{data:i,error:o}=await ie.storage.from("live-audience-images").upload(a,n,{contentType:"image/png",cacheControl:"3600",upsert:!1});if(o)throw o;return a}function j(e){const t=e.split(","),n=t[0].match(/:(.*?);/)[1],a=atob(t[1]);let i=a.length;const o=new Uint8Array(i);for(;i--;)o[i]=a.charCodeAt(i);return new Blob([o],{type:n})}function D(e,t=320){const n=document.createElement("canvas");let a=e.videoWidth,i=e.videoHeight;return a>i?a>t&&(i*=t/a,a=t):i>t&&(a*=t/i,i=t),n.width=a,n.height=i,n.getContext("2d").drawImage(e,0,0,a,i),{dataURL:n.toDataURL(),width:a,height:i}}function M(e=new Date){return[String(e.getFullYear()),String(e.getMonth()+1).padStart(2,"0"),String(e.getDate()).padStart(2,"0")].join("-")}function A(e=new Date){return[String(e.getHours()).padStart(2,"0"),String(e.getMinutes()).padStart(2,"0"),String(e.getSeconds()).padStart(2,"0")].join("-")}function O(e=new Date){return[String(e.getHours()).padStart(2,"0"),String(e.getMinutes()).padStart(2,"0"),String(e.getSeconds()).padStart(2,"0")].join(":")}function U(){return new Promise((e,t)=>{const n=(Date.now()-pe)/1e3;if(n>300||null==ge){null!=ge&&(ye?turnstile.reset():ye=!0);const n=document.getElementById("turnstile-container");n.innerHTML="",turnstile.render("#turnstile-container",{sitekey:"0x4AAAAAAB58hE2F_vwmF7sB",callback:async function(t){pe=Date.now(),ge=t,e(t)},"error-callback":function(e){t(e)}})}else e(ge)})}async function $(){return new Promise(async(e,t)=>{const n=document.getElementById("text-name").value,a=document.getElementById("textarea-comment").value;if(""==n||""==a)throw alert("Both inputs are required."),t("Both inputs are required."),Error("Both inputs are required.");oe=n,se=a,null==we&&await f();const i=await V();if(!i)throw Error("Failed Live Audience Agreement");let o;const s=document.getElementById("camera-blur");s.onchange=(()=>{gsap.set(`#${ve.id}`,{filter:`blur(${s.value}px)`})});const r=setTimeout(function(){alert("Camera permissions should have been requested. Check browser/site settings."),t("Camera permissions should have been requested. Check browser/site settings.")},1e4);navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({video:!0}).then(function(t){t.getVideoTracks()[0].getSettings().deviceId;const n=document.getElementById("camera-select");navigator.mediaDevices.enumerateDevices().then(e=>{const t=e.filter(e=>"videoinput"===e.kind);n.innerHTML=t.map(e=>`<option value="${e.deviceId}">${e.label||"Camera"}</option>`).join("")}),n.onchange=(async()=>{o&&o.getTracks().forEach(e=>e.stop());const e={video:{deviceId:{exact:n.value}}};o=await navigator.mediaDevices.getUserMedia(e),ve.srcObject=o}),clearTimeout(r),ve.srcObject=t,e(t)}).catch(function(e){clearTimeout(r),alert("Camera access denied."),t(e)}):(clearTimeout(r),alert("Camera not supported in this browser."),t("Camera not supported in this browser."))})}function N(e=!1){e||T(),clearInterval(ae);const t=ve.srcObject;if(t){const e=t.getTracks();e.forEach(e=>e.stop()),ve.srcObject=null}}async function R(e,t){const{data:n,error:a}=await ie.functions.invoke(e,{body:t});return n}function P(e){e&&alert(e.message)}function z(){if(de=document.getElementById("layoutContainer"),null!=le)return{_layoutEl:de,_layout:le};le=initLayoutContainer(de,{fixedRatio:!1,minRatio:9/16,maxRatio:16/9,scaleLastRow:!0,alignItems:"center"}).layout,window.addEventListener("resize",()=>le())}function F(e,t,n){ce=OT.initSession(e,t),ce.on("streamCreated",function(e){const t=ce.subscribe(e.stream,de,{insertMode:"append",width:"100%",height:"100%",fixedRatio:!1},P);t.on("videoElementCreated",function(e){q&&(e.element.style.filter=be[Ee][0].filter)}),ke.push(t),le()}),ce.on("streamDestroyed",function(e){e.stream.destroy(),le(),alert("Stream Destroyed."),location.reload()}),ce.on("streamPropertyChanged",e=>{"videoDimensions"===e.changedProperty&&le()}),ce.on("sessionDisconnected",e=>{ke.forEach(e=>e.destroy()),ke.length=0,de.innerHTML="",le()});let a={insertMode:"append",width:"100%",height:"100%"};Q&&(a.videoSource=document.getElementById("camera-select").value);const i=OT.initPublisher(de,a,P);i.on("videoElementCreated",e=>{Q&&(e.element.style.filter=document.getElementById(ve.id).style.filter)}),le(),ce.connect(n,function(e){e?P(e):ce.publish(i,P)})}async function V(){try{const e=document.getElementById("agreement").innerHTML,{data:t,error:n}=await ie.functions.invoke("live-audience-agreement",{body:{name:"Functions",user_id:we.user.id,agreement:e,app_name:G}});if(n)throw n;return t}catch(e){throw new Error(e)}}async function Y(){const{error:e}=await sb.auth.signOut()}const W="0.1.9-beta",G=t(),J=["livehotseat"],q=J.includes(G),X=["polrized","weekdaze"],Z="weekdaze",Q=X.includes(G),K=window.location.hostname.includes(".wstd.io"),ee="https://edfgdkdaurrrygzyfiyc.supabase.co",te="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZmdka2RhdXJycnlnenlmaXljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NDczNzgsImV4cCI6MjA3MTQyMzM3OH0.AWa3MC8T7nPYukDU7BI5yc9BOe5XbKCMV_1-R8RI6ZE",ne=document.getElementById("live-button");let ae,ie,oe,se,re,ce,le,de,ue=!1,me=null,ye=!1,pe=null,ge=null,ve=null,he=null,fe=null,we=null,be={},Ie=null,Se=new Map,Le=new Map,Ee=null,_e=!1,ke=[],Be=null,He=null,Ce=null,Te=null,xe=3,je=()=>{const e=document.getElementById("loading-text");switch(xe+=1,xe){case 1:e.innerHTML="Loading.";break;case 2:e.innerHTML="Loading..";break;case 3:e.innerHTML="Loading...";break;default:e.innerHTML="Loading",xe=0}},De=setInterval(je,1e3);je();let Me={init:e,subscribe:o,startLiveAudience:$,stopLiveAudience:N,startLiveHotSeat:r,stopLiveHotSeat:c,offerLiveHotSeat:S,signOut:Y};return q&&(Me.offerLiveHotSeat=S,Me.loginWithEmail=u),Me}();window.LiveHotSeat=LiveHotSeat;