const LiveHotSeat=function(){async function e(){if(ye)return;ye=!0,a(),i(),await Promise.all([d("https://www.youtube.com/iframe_api",!1),d("https://challenges.cloudflare.com/turnstile/v0/api.js",!1),d("https://unpkg.com/@supabase/supabase-js@2.43.3/dist/umd/supabase.js",!1),d("https://unpkg.com/gsap@3/dist/gsap.min.js",!1),d("https://unpkg.com/gsap@3/dist/TextPlugin.min.js",!1),d("https://unpkg.com/gsap@3/dist/SplitText.min.js",!1),d("https://unpkg.com/@vonage/client-sdk-video@2/dist/js/opentok.js",!1),d("https://unpkg.com/opentok-layout-js@5.5.0/opentok-layout.js",!1),d(`https://livehotseat.nightowllogic.com/${te?J:J+".min"}.js`,!0),u("https://livehotseat.nightowllogic.com/common.css"),u(`https://livehotseat.nightowllogic.com/${J}.css`)]),se=window.supabase.createClient(ne,ae);const e=document.createElement("div");e.id="turnstile-container",document.body.appendChild(e);const t=document.createElement("div");if(t.id="version",t.style.display="none",t.innerHTML=G,document.body.appendChild(t),await p(),se.auth.onAuthStateChange(async(e,t)=>{switch(e){case"INITIAL_SESSION":const{error:n,success:a}=await y();if(n)throw n;a?(Ie=t,await v(!0)):Ie=null,X&&(a?await x():document.getElementById("sign-in-flexbox").style.display="flex"),ee&&(a||(await v(),he=null));break;case"SIGNED_IN":Ie=t,X&&null==we&&(await v(!0),await x())}}),ee){document.getElementById("text-name").setAttribute("maxlength","25"),document.getElementById("textarea-comment").setAttribute("maxlength","130"),fe=document.createElement("video"),fe.id="user-camera-live-audience-video",fe.style.width="160px",fe.style.height="160px",fe.style.borderRadius="6px",fe.style.background="#000",fe.style.display="block",fe.style.objectFit="cover",fe.autoplay=!0,fe.playsInline=!0,fe.addEventListener("loadeddata",async function(){o({event:"SIGNED_IN_WITH_EMAIL"}),await C()});const e=document.getElementById("live-audience-body"),t=document.getElementById("sign-out-camera-button");e.insertBefore(fe,t)}X&&ie.addEventListener("mouseup",async()=>{await h()}),window.addEventListener("blur",()=>_isBlurred=!0),window.addEventListener("focus",()=>_isBlurred=!1);const n=document.createElement("div");n.id="layoutContainer",document.body.appendChild(n),clearInterval(Ae),document.getElementById("loading-dialog").style.display="none",document.getElementById("loading-text").innerHTML="Loading...",o({event:"READY"})}function t(){const e=document.currentScript,t=new URL(e.src),n=new URLSearchParams(t.search),a=n.get("app");return a}function n(){const e=localStorage.getItem("is-host-on-client");return e}function a(){const e=localStorage.getItem("LiveHotSeatUserId");null!=e&&(ke=e)}function i(){if(!ee&&!X)throw new Error("Live Hot Seat App Website Permission Error.");const e=te?`https://${J}com.wstd.io`:`https://www.${J}.com`;if(window.location.origin!=e)throw new Error("Live Hot Seat App Website Permission Error.")}function o(e){"function"==typeof xe&&xe(e)}function s(e){xe=e}function r(){Ce=document.createElement("iframe"),Ce.id="ytplayeriframe",Ce.type="text/html",Ce.src=`https://www.youtube-nocookie.com/embed/${je}?si=RW9jDGDcqqPgCgr6$?autoplay=0&rel=0&playsinline=1&keyboard=0&iv_load_policy=3&fs=0&controls=0&mute=0&enablejsapi=1&showinfo=0&modestbranding=1`,Ce.allow="accelerometer; autoplay;",Ce.style.width="100vw",Ce.style.height="100vh",Ce.style.position="absolute",Ce.style.border="none",Ce.style.zIndex=2;const e=document.getElementById("fullscreen-video-container"),t=document.getElementById("vimeoplayer");e.insertBefore(Ce,t),e.style.zIndex=3,Te=new YT.Player("ytplayeriframe",{}),Te.addEventListener("onStateChange",function(t){t.data===YT.PlayerState.PLAYING&&(e.style.zIndex=-1,Te.setVolume(100))}),document.getElementById("vimeoplayer").remove()}async function c(){null!=fe&&null!=be&&(R(!0),Ce&&Ce.parentNode&&Ce.parentNode.removeChild(Ce),Te&&(Te=null),await be.send({type:"broadcast",event:"private_message",payload:{user_id:Ie.user.id,display_name:re,acceptedLiveHotSeat:!0,sent_at:(new Date).toISOString()}}));const{applicationId:e,sessionId:t,token:n}=await P("vonage-session-endpoint",{name:"Functions",role:X?"moderator":"publisher"});null==ue&&F();const a=document.getElementById("layoutContainer");a.style.display="flex",He=[],V(e,t,n)}async function l(){const e=document.getElementById("layoutContainer");e.style.display="none",X?(await _(ke,{closeLiveHotSeat:!0}),ke=null,localStorage.setItem("LiveHotSeatUserId",null)):await be.send({type:"broadcast",event:"private_message",payload:{user_id:Ie.user.id,closeLiveHotSeat:!0,sent_at:(new Date).toISOString()}}),de.disconnect(),location.reload()}async function d(e,t=!0){return new Promise((n,a)=>{const i=document.createElement("script");i.src=te&&t?e+"?v="+(new Date).getTime():e,i.async=!0,i.onload=n,i.onerror=a,document.head.appendChild(i)})}async function u(e){return new Promise((t,n)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=e+"?v="+(new Date).getTime(),a.onload=t,a.onerror=n,document.head.appendChild(a)})}async function m(e,t){const n=await U(),{data:a,error:i}=await se.auth.signInWithPassword({email:e,password:t,options:{captchaToken:n}}),s=null!=a.session;s&&o({event:"SIGNED_IN_WITH_EMAIL"})}async function y(){const{data:e,error:t}=await se.auth.getSession(),n=null!=e.session;return n&&o({event:"SIGNED_IN_WITH_CURRENT_SESSION"}),{error:t,success:n}}async function p(){const e=await P("version",{name:"Functions"});e.version!=G&&(alert(`Version mismatch: ${e.version} != ${G}`),location.reload(!0)),document.getElementById("version").style.display="block"}function g(){ie.innerHTML=pe?`End Live (${K})`:`Go Live (${K})`,ie.style.backgroundColor=pe?"red":"rgb(222, 226, 230)",ie.style.display="inline-block"}async function v(e=!1){if(e){const{isLive:e,youTubeVideoId:t}=await P("is-show-live-no-token",{name:"Functions",app_name:X?K:J});pe=e,je=t}else{const e=await U(),{isLive:t,youTubeVideoId:n}=await P("is-show-live",{name:"Functions",token:e,app_name:X?K:J});pe=t,je=n}X&&g(),ee&&pe&&(document.getElementById("open-live-hot-seat-button").style.display="inline-block",Z||r())}async function h(){ie.style.display="none";const{isLive:e}=await P("set-is-show-live",{name:"Functions",isLive:!pe,app_name:K,youTubeVideoId:je});if("boolean"!=typeof e)throw new Error(`Failed ${K} is Live...`);pe=!pe,g(),await f()}async function f(){!pe&&Object.keys(Se).length>0&&Object.keys(Se).forEach(async e=>{await _(e,{isLive:!1})})}async function w(){const e=await U(),{data:t,error:n}=await se.auth.signInAnonymously({options:{captchaToken:e}}),a=null!=t.session;a&&o({event:"SIGNED_IN_ANONYMOUSLY"})}async function b(e){const{data:t,error:n}=await se.storage.from("live-audience-images").download(e);if(!n)return t}function I(e){const t=Object.keys(Se),n=document.querySelectorAll(".image-grid img");n.forEach(e=>{if(!t.includes(e.id)){const t=e.closest(".image-item");B(t),_e.delete(e.id),e.id==ke&&(ke=null,localStorage.setItem("LiveHotSeatUserId",null))}}),e.forEach(e=>H(e))}async function S(e){if(Ee.has(e))return Ee.get(e);const t=await b(e),n=URL.createObjectURL(t);return Ee.set(e,n),n}async function L(e){const t=document.getElementById(e).closest(".image-item");t.classList.contains("selected")?(await _(e,{declineLiveHotSeat:!0}),ke=null,localStorage.setItem("LiveHotSeatUserId",null),t.classList.remove("selected")):(await _(e,{offerLiveHotSeat:!0}),ke=e,localStorage.setItem("LiveHotSeatUserId",ke),t.classList.add("selected"))}function E(e){const t=e.payload;if("user_id"in t&&ke==t.user_id)if(Be)"closeLiveHotSeat"in t&&t.closeLiveHotSeat&&l();else{if(!("acceptedLiveHotSeat"in t))return;Be=!0,le=t.filter,X&&(ie.style.display="none"),document.querySelector(".image-grid").style.display="none",document.getElementById("heading-image-grid").style.display="none",document.getElementById("close-live-hot-seat-flexbox").style.display="flex",c()}}async function _(e,t){if(!_e.has(e))return;const n=_e.get(e);try{await n.send({type:"broadcast",event:"private_message",payload:{message:t,sent_at:(new Date).toISOString()}})}catch(e){throw new Error(e)}}function k(e){if(_e.has(e))return _e.get(e);const t=se.channel(`room:${e}:messages`,{config:{private:!0,broadcast:{ack:!0}}});return t.on("broadcast",{event:"private_message"},E).subscribe(),_e.set(e,t),t}function B(e){const t=.3;e.style.transition=`opacity ${t}s ease`,e.style.opacity=0,setTimeout(()=>e.remove(),1e3*t)}function H(e){const t=document.getElementsByClassName("image-grid")[0],n=document.getElementById(`${e.user_id}`);if(n)n.src=e.live_audience_image_url,n.style.filter=e.filter;else{const n=document.createElement("div");n.className="image-item",e.user_id==ke&&n.classList.add("selected");const a=document.createElement("img");a.id=`${e.user_id}`,a.src=e.live_audience_image_url,a.loading="lazy",a.alt=`User ${e.user_id}`,a.title=`[ ${e.display_name} ] ${e.comment}`,a.style.filter=e.filter;const i=document.createElement("button");i.className="hover-btn",i.textContent="Live Hot Seat",i.style="font-size: .2rem",n.appendChild(a),n.appendChild(i),t.appendChild(n)}}async function x(){we=se.channel(K,{config:{private:!1,broadcast:{self:!0,ack:!0},presence:{key:Ie.user.id}}}),we.on("presence",{event:"join"},({key:e,newPresences:t})=>{Se[e]=t[0]}).on("presence",{event:"leave"},({key:e})=>{delete Se[e]}).on("presence",{event:"sync"},()=>{const e=we.presenceState();Object.assign(Se,e),Object.keys(Se).length>0&&Object.keys(Se).forEach(e=>{k(e)}),clearTimeout(Le),Le=null,Be||(Le=setTimeout(async()=>{const t=Object.entries(e).map(async([e,[t]])=>({...t,user_id:e,live_audience_image_url:await S(t.live_audience_image)})),n=await Promise.all(t);I(n)},1e3))}).subscribe()}async function C(){try{const e=`room:${Ie.user.id}:messages`;be=se.channel(e,{config:{private:!0,broadcast:{ack:!0}}}),we=se.channel(J,{config:{private:!1,broadcast:{self:!0,ack:!0},presence:{key:Ie.user.id}}}),we.subscribe(async e=>{if("SUBSCRIBED"!==e)return;const t=document.getElementById("camera-blur"),n=M(fe),a=await j({user_id:Ie.user.id,dataURL:n.dataURL});we.track({updated_at:$(),display_name:re,live_audience_image:a,comment:ce,width:n.width,height:n.height,filter:`blur(${t.value}px)`}),oe=setInterval(async function(){const e=M(fe),n=await j({user_id:Ie.user.id,dataURL:e.dataURL});we.track({updated_at:$(),display_name:re,live_audience_image:n,comment:ce,width:e.width,height:e.height,isFocused:!window.isBlurred,filter:`blur(${t.value}px)`})},1e4)}),be.on("broadcast",{event:"private_message"},e=>{"offerLiveHotSeat"in e.payload.message&&e.payload.message.offerLiveHotSeat&&gsap.set("#accept-live-hot-seat-flexbox",{display:"flex",top:"50%"}),"declineLiveHotSeat"in e.payload.message&&e.payload.message.declineLiveHotSeat&&gsap.set("#accept-live-hot-seat-flexbox",{display:"none"}),"closeLiveHotSeat"in e.payload.message&&e.payload.message.closeLiveHotSeat&&location.reload(),"isLive"in e.payload.message&&!e.payload.message.isLive&&location.reload()}).subscribe()}catch(e){}}function T(){gsap.set("#accept-live-hot-seat-flexbox",{display:"none"}),se.removeAllChannels()}async function j({user_id:e,dataURL:t}){const n=D(t),a=`${A()}/${e}/${O()}.png`,{data:i,error:o}=await se.storage.from("live-audience-images").upload(a,n,{contentType:"image/png",cacheControl:"3600",upsert:!1});if(o)throw o;return a}function D(e){const t=e.split(","),n=t[0].match(/:(.*?);/)[1],a=atob(t[1]);let i=a.length;const o=new Uint8Array(i);for(;i--;)o[i]=a.charCodeAt(i);return new Blob([o],{type:n})}function M(e,t=320){const n=document.createElement("canvas");let a=e.videoWidth,i=e.videoHeight;return a>i?a>t&&(i*=t/a,a=t):i>t&&(a*=t/i,i=t),n.width=a,n.height=i,n.getContext("2d").drawImage(e,0,0,a,i),{dataURL:n.toDataURL(),width:a,height:i}}function A(e=new Date){return[String(e.getFullYear()),String(e.getMonth()+1).padStart(2,"0"),String(e.getDate()).padStart(2,"0")].join("-")}function O(e=new Date){return[String(e.getHours()).padStart(2,"0"),String(e.getMinutes()).padStart(2,"0"),String(e.getSeconds()).padStart(2,"0")].join("-")}function $(e=new Date){return[String(e.getHours()).padStart(2,"0"),String(e.getMinutes()).padStart(2,"0"),String(e.getSeconds()).padStart(2,"0")].join(":")}function U(){return new Promise((e,t)=>{const n=(Date.now()-ve)/1e3;if(n>300||null==he){null!=he&&(ge?turnstile.reset():ge=!0);const n=document.getElementById("turnstile-container");n.innerHTML="",turnstile.render("#turnstile-container",{sitekey:"0x4AAAAAAB58hE2F_vwmF7sB",callback:async function(t){ve=Date.now(),he=t,e(t)},"error-callback":function(e){t(e)}})}else e(he)})}async function N(){return new Promise(async(e,t)=>{const n=document.getElementById("text-name").value,a=document.getElementById("textarea-comment").value;if(""==n||""==a)throw alert("Both inputs are required."),t("Both inputs are required."),Error("Both inputs are required.");re=n,ce=a,null==Ie&&await w();const i=await W();if(!i)throw Error("Failed Live Audience Agreement");let o;const s=document.getElementById("camera-blur");s.onchange=(()=>{gsap.set(`#${fe.id}`,{filter:`blur(${s.value}px)`})}),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({video:!0}).then(function(t){t.getVideoTracks()[0].getSettings().deviceId;const n=document.getElementById("camera-select");navigator.mediaDevices.enumerateDevices().then(e=>{const t=e.filter(e=>"videoinput"===e.kind);n.innerHTML=t.map(e=>`<option value="${e.deviceId}">${e.label||"Camera"}</option>`).join("")}),n.onchange=(async()=>{o&&o.getTracks().forEach(e=>e.stop());const e={video:{deviceId:{exact:n.value}}};o=await navigator.mediaDevices.getUserMedia(e),fe.srcObject=o}),fe.srcObject=t,e(t)}).catch(function(e){alert("Camera access denied."),t(e)}):(alert("Camera not supported in this browser."),t("Camera not supported in this browser."))})}function R(e=!1){e||T(),clearInterval(oe);const t=fe.srcObject;if(t){const e=t.getTracks();e.forEach(e=>e.stop()),fe.srcObject=null}}async function P(e,t){const{data:n,error:a}=await se.functions.invoke(e,{body:t});return n}function z(e){e&&alert(e.message)}function F(){if(me=document.getElementById("layoutContainer"),null!=ue)return{_layoutEl:me,_layout:ue};ue=initLayoutContainer(me,{fixedRatio:!1,minRatio:9/16,maxRatio:16/9,scaleLastRow:!0,alignItems:"center"}).layout,window.addEventListener("resize",()=>ue())}function V(e,t,n){de=OT.initSession(e,t),de.on("streamCreated",function(e){const t=de.subscribe(e.stream,me,{insertMode:"append",width:"100%",height:"100%",fixedRatio:!1},z);t.on("videoElementCreated",function(e){X&&(e.element.style.filter=Se[ke][0].filter)}),He.push(t),ue()}),de.on("streamDestroyed",function(e){e.stream.destroy(),ue(),alert("Stream Destroyed."),location.reload()}),de.on("streamPropertyChanged",e=>{"videoDimensions"===e.changedProperty&&ue()}),de.on("sessionDisconnected",e=>{He.forEach(e=>e.destroy()),He.length=0,me.innerHTML="",ue()});let a={insertMode:"append",width:"100%",height:"100%"};ee&&(a.videoSource=document.getElementById("camera-select").value);const i=OT.initPublisher(me,a,z);i.on("videoElementCreated",e=>{ee&&(e.element.style.filter=document.getElementById(fe.id).style.filter)}),ue(),de.connect(n,function(e){e?z(e):de.publish(i,z)})}async function W(){try{const e=document.getElementById("agreement").innerHTML,{data:t,error:n}=await se.functions.invoke("live-audience-agreement",{body:{name:"Functions",user_id:Ie.user.id,agreement:e,app_name:J}});if(n)throw n;return t}catch(e){throw new Error(e)}}async function Y(){const{error:e}=await sb.auth.signOut()}const G="0.1.9-beta",J=t(),q=["livehotseat"],X=q.includes(J),Z=n(),Q=["polrized","weekdaze"],K="weekdaze",ee=Q.includes(J),te=window.location.hostname.includes(".wstd.io"),ne="https://edfgdkdaurrrygzyfiyc.supabase.co",ae="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZmdka2RhdXJycnlnenlmaXljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NDczNzgsImV4cCI6MjA3MTQyMzM3OH0.AWa3MC8T7nPYukDU7BI5yc9BOe5XbKCMV_1-R8RI6ZE",ie=document.getElementById("live-button");let oe,se,re,ce,le,de,ue,me,ye=!1,pe=null,ge=!1,ve=null,he=null,fe=null,we=null,be=null,Ie=null,Se={},Le=null,Ee=new Map,_e=new Map,ke=null,Be=!1,He=[],xe=null,Ce=null,Te=null,je=null,De=3,Me=()=>{const e=document.getElementById("loading-text");switch(De+=1,De){case 1:e.innerHTML="Loading.";break;case 2:e.innerHTML="Loading..";break;case 3:e.innerHTML="Loading...";break;default:e.innerHTML="Loading",De=0}},Ae=setInterval(Me,1e3);Me();let Oe={init:e,subscribe:s,startLiveAudience:N,stopLiveAudience:R,startLiveHotSeat:c,stopLiveHotSeat:l,offerLiveHotSeat:L,signOut:Y};return X&&(Oe.offerLiveHotSeat=L,Oe.loginWithEmail=m),Oe}();window.LiveHotSeat=LiveHotSeat;